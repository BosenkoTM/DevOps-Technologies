# Лабораторная работа №2. Упаковка многокомпонентного аналитического приложения с помощью Docker и Docker Compose


## Цель работы
Научиться создавать оптимизированные Docker-образы для аналитических приложений (Python/Data Science стек) и оркестрировать взаимодействие нескольких сервисов (ETL-скрипт, База Данных, Визуализация) с помощью Docker Compose, обеспечивая сохранение данных и безопасное управление конфигурацией.

## Исходные данные и инструменты
Используется кодовая база и наборы данных, подготовленные в **Лабораторной работе №1**.
Теперь локальный проект необходимо превратить в переносимый микросервисный продукт.

**Архитектура решения (на основе Практической работы 3.2):**
-  **Service `db`**. База данных для хранения обработанных метрик (PostgreSQL или MongoDB).
-  **Service `loader` (init)**. Одноразовый (ephemeral) контейнер. Выполняет роль ETL-скрипта: запускается, читает сырые данные (CSV/JSON из ЛР1), загружает их в БД и завершает работу.
-  **Service `analytics_app`**. Основное приложение (Streamlit, Flask API или JupyterLab), которое подключается к БД, забирает данные и отображает результаты/дашборд.

## Ход работы

### Этап 1. Разработка оптимизированного Dockerfile
*Базируется на Практической работе 3.1 (Bad vs Good practices).*
Для сервиса `analytics_app` необходимо написать `Dockerfile`, соблюдая "Хорошие практики":
-  **Базовый образ.** Использовать конкретные версии (например, `python:3.10-slim`, а не `latest`).
-  **Пользователь.** Создать и использовать непривилегированного пользователя (`UID 1000`), не запускать от `root`.
-  **Слои и кэш.** Объединять команды `RUN`, устанавливать зависимости (`pip install`) до копирования основного кода (`COPY . .`), чтобы использовать кэш Docker.
-  **Очистка.** Удалять кэш пакетного менеджера (`rm -rf /var/lib/apt/lists/*` или `--no-cache-dir`).
-  **`.dockerignore`.** Исключить `venv`, `.git`, `__pycache__` и локальные файлы данных.

### Этап 2. Настройка Docker Compose
*Базируется на Практической работе 3.2.*
Создать файл `docker-compose.yml`, описывающий инфраструктуру:
-  **Depends_on.** Настроить порядок запуска (приложение ждет БД). Использовать `condition: service_healthy` (healthchecks).
-  **Volumes:**
    *   Для БД: именованный том (named volume) для сохранения данных между перезапусками.
    *   Для загрузчика: `bind mount` локальной папки с сырыми данными (только для чтения).
-  **Networks.** Все сервисы должны находиться в одной изолированной сети `backend-network`.
-  **Environment.** Переменные (логин/пароль БД, порты) вынести в файл `.env`. **Запрещено** хардкодить пароли в `docker-compose.yml`.

### Этап 3. Реализация Healthcheck и Init-контейнера
-  Добавить `healthcheck` для сервиса базы данных (проверка доступности порта или ответ на пинг).
-  Сервис `loader` должен запускаться только после того, как `db` перейдет в статус `healthy`.

---

## Варианты заданий (Кейсы)

Продолжаем работу с предметной областью из ЛР1.
**Бизнес-задача** — та же, что в ЛР1.
**Проектная задача** — какой компонент необходимо упаковать.
**Техническое задание** — специфическое требование к Docker/Compose для демонстрации углубленных навыков.

| Вариант | Категория (ЛР1) | Бизнес-задача (Контекст) | Проектная задача (Архитектура) | Техническое задание (Docker/Compose Constraints) |
|:---:|:---:|:---|:---|:---|
| **1** | Финансы | Churn Prediction (Отток) | `app`: API на Flask, отдающее вероятность оттока. | Использовать **Multi-stage build** в Dockerfile: отдельный этап `builder` для компиляции зависимостей. |
| **2** | Финансы | Crypto Volatility | `app`: Streamlit дашборд с графиками курса. | Настроить **Restart Policy**: `on-failure` для приложения и `always` для БД. |
| **3** | Финансы | Кредитный скоринг | `app`: Jupyter Lab для аналитиков (доступ по токену). | Пробросить порты так, чтобы Jupyter был доступен только на `127.0.0.1`, но не извне. |
| **4** | Финансы | Портфель Марковица | `app`: Скрипт генерации PDF-отчета по расписанию. | Использовать **Entrypoint** скрипт, который проверяет доступность БД через `netcat` перед стартом Python. |
| **5** | Финансы | Fraud Detection | `db`: Redis (для быстрого кеша транзакций). | Настроить лимиты ресурсов: **deploy resources limits** (CPU 0.5, RAM 512MB) для контейнера приложения. |
| **6** | Финансы | Выручка филиалов | `db`: PostgreSQL. `loader`: SQL-скрипт инициализации схемы. | Использовать `volume` типа **tmpfs** для временных файлов обработки данных (безопасность/скорость). |
| **7** | Финансы | Маркетинг (ROI) | `app`: Dash (Plotly) приложение. | Организовать **логирование**: драйвер json-file с ограничением размера лога (`max-size: "10m"`). |
| **8** | Финансы | Аудит расходов | `app`: Python-скрипт, пишущий логи в файл. | Использовать **Bind Mount** для папки логов, чтобы анализировать их с хост-машины в реальном времени. |
| **9** | Финансы | Ликвидность | `app`: FastAPI сервис. | Аргументы сборки (**ARG**): передавать версию приложения при билде и выводить её при старте. |
| **10** | Финансы | Дефолт заемщиков | `db`: PostgreSQL + pgAdmin (интерфейс к БД). | Добавить 4-й сервис: **pgAdmin** (или GUI для вашей БД), зависящий от сервиса БД. |
| **11** | Ритейл | RFM-анализ | `app`: Streamlit. `db`: MongoDB. | Настроить **Healthcheck** для MongoDB: команда `mongosh --eval 'db.runCommand("ping").ok'`. |
| **12** | Ритейл | Market Basket | `loader`: Python скрипт c `pandas`, грузящий JSON в БД. | Оптимизация: установить зависимости через `pip install --no-cache-dir` и удалить компиляторы (gcc) после установки. |
| **13** | Ритейл | Сезонный спрос | `app`: Модель Prophet в контейнере. | Использовать файл `.dockerignore`, чтобы исключить локальную папку `.venv` и тяжелые `.csv` (только через volume). |
| **14** | Ритейл | Отзывы (NLP) | `app`: Загрузка NLTK/Spacy моделей. | Скачивать модели NLP в отдельном слое Dockerfile или монтировать их как volume, чтобы не качать при каждом билде. |
| **15** | Ритейл | Складские запасы | `db`: PostgreSQL. | Использовать **переменные окружения** в Dockerfile (`ENV`) для настройки путей к конфигам. |
| **16** | Ритейл | A/B тесты | `app`: Jupyter Notebook. | Задать фиксированное имя контейнера (`container_name`) и hostname для удобства обращения внутри сети. |
| **17** | Ритейл | Возвраты товаров | `app`: Web-интерфейс на Django/FastAPI. | Разделить сети: сеть `data-net` (БД+App) и сеть `public-net` (App+Host). БД не должна быть в `public-net`. |
| **18** | Ритейл | Рекомендации | `loader`: Загрузка матрицы товаров. | Реализовать паттерн **Init Container** через `service_healthy`: App не стартует, пока Loader не закончит работу (exit code 0). |
| **19** | Ритейл | Воронка продаж | `app`: Графана (визуализация) + БД. | Поднять связку **Postgres + Grafana**. App заливает данные в Postgres, Grafana их читает (без кода на Python для UI). |
| **20** | Ритейл | Гео-аналитика | `db`: PostGIS (Postgres с расширением). | Использовать специализированный базовый образ для БД (`postgis/postgis`) вместо стандартного `postgres`. |
| **21** | Здравоохр. | Эпидемии | `app`: Map-dashboard (Folium). | Создать пользователя `appuser` с `UID 5000` и настроить права доступа к рабочей директории (`chown`). |
| **22** | Здравоохр. | Эффективность лекарств | `app`: R-Studio или Python+SciPy. | Если используется Python, создать **Multi-stage** build для минимизации размера итогового образа (distroless или alpine). |
| **23** | Здравоохр. | Койко-места | `db`: TimescaleDB (или Postgres). | Настроить сохранение данных БД в **Named Volume** (`docker volume create`), чтобы данные переживали `docker-compose down`. |
| **24** | Здравоохр. | MRI (Снимки) | `app`: TensorFlow Serving (или mock). | Работа с большими файлами: настроить `ulimits` (memlock) в docker-compose для ML-контейнера. |
| **25** | Здравоохр. | Диабет (Риски) | `loader`: Скрипт анонимизации данных перед загрузкой. | Использовать секреты (**Docker Secrets** или эмуляцию через файлы), чтобы передать ключи шифрования, а не через ENV. |
| **26** | Здравоохр. | Стоимость услуг | `app`: Excel-генератор (Pandas+XlsxWriter). | Монтировать локальную папку `./reports` в контейнер на запись, чтобы получать сгенерированные отчеты на хосте. |
| **27** | Здравоохр. | Запасы медикаментов | `db`: MySQL. | Настроить **Healthcheck** для MySQL (используя `mysqladmin ping`). |
| **28** | Здравоохр. | Приемы врачей | `app`: Streamlit. | Сделать **Build Args** для выбора установки dev-зависимостей (тесты, линтеры) или только prod. |
| **29** | Здравоохр. | Медкарта (NLP) | `loader`: Загрузка текстовых корпусов. | Реализовать команду (`command`) в Compose, переопределяющую `CMD` из Dockerfile для режима отладки. |
| **30** | Здравоохр. | Удовлетворенность | `app`: Web-опросник. | Масштабирование: подготовить конфиг для запуска **2-х реплик** приложения (`deploy: replicas: 2`) и балансировщика (Nginx). |
| **31** | Логистика | Маршруты (OSM) | `app`: OSRM (или скрипт с NetworkX). | Использовать внешний том (read-only) для файлов карт, чтобы не копировать гигабайты данных в образ. |
| **32** | Логистика | Предиктивный ремонт | `db`: InfluxDB (или Postgres). | Настроить **Retention Policy** (на уровне логики или БД) для старых данных через переменные окружения. |
| **33** | Логистика | Цепочки поставок | `app`: Dash приложение. | Настроить **Healthcheck** для приложения: `curl -f http://localhost:8080/ || exit 1` (потребует установки curl в образ). |
| **34** | Энергетика | Потребление э/э | `loader`: API Poller (погода). | Передача API-ключа через файл `.env`. Убедиться, что `.env` добавлен в `.gitignore` (проверка в отчете). |
| **35** | Энергетика | Солнечные панели | `app`: Расчет инсоляции. | Объединить 3 и более команд `RUN` в одну цепочку в Dockerfile для уменьшения слоев. |
| **36** | Энергетика | Выбросы CO2 | `app`: Генератор PDF. | Установить системные зависимости (шрифты, libgl1) в Dockerfile корректно, с очисткой `apt-get clean`. |
| **37** | Логистика | Порты (MarineTraffic) | `db`: ClickHouse (или Postgres). | Настроить инициализацию БД через `/docker-entrypoint-initdb.d/` (стандартный механизм Postgres/MySQL образов). |
| **38** | Энергетика | Smart Grid | `app`: Simulation script. | Настроить **Graceful Shutdown**: приложение должно корректно обрабатывать SIGTERM при остановке контейнера. |
| **39** | Логистика | Last Mile | `app`: Solver (алгоритм). | Использовать базовый образ **Python Alpine** и решить проблемы с установкой `pandas/numpy` (нужны build-deps). |
| **40** | Логистика | Такси парк | `app`: Heatmap visualizer. | Прокинуть (expose) нестандартный порт (например, 8501 для Streamlit) на 80-й порт хоста. |

---

## Критерии оценки (Максимум 10 баллов)

| Критерий | Баллы | Требования к выполнению |
|:---|:---:|:---|
| **1. Качество Dockerfile (Best Practices)** | **3** | Dockerfile написан оптимально: используется фиксированная версия базового образа, команды `RUN` объединены, кэш очищается, используется **непривилегированный пользователь**, настроен `.dockerignore`. |
| **2. Оркестрация Docker Compose** | **3** | Файл `docker-compose.yml` корректен. Реализована связка минимум 3-х сервисов (`init/loader`, `db`, `app`). Настроены `depends_on` с учетом healthcheck (приложение реально ждет готовности БД). |
| **3. Конфигурация и Безопасность** | **2** | Отсутствие хардкода: пароли, порты и ключи вынесены в `.env` файл. Данные базы данных сохраняются в volume. Сеть настроена корректно. |
| **4. Выполнение технического задания варианта** | **1** | Реализована специфика варианта (например, Multi-stage build, настройка ресурсов, healthcheck для конкретной БД и т.д.). |
| **5. Отчет и Демонстрация** | **1** | В репозитории есть скриншоты (команда `docker ps`, логи успешного соединения App с DB, работающий интерфейс в браузере). Описана структура проекта в README. |

**Результат.** Ссылка на репозиторий GitHub/GitVerse (продолжение репозитория ЛР1), содержащий папку `lab_02` или обновленный корень проекта с Docker-конфигурацией.