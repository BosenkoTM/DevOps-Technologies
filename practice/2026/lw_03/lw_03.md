# Лабораторная работа №3. Развертывание аналитического сервиса в кластере Kubernetes


## 1. Цель работы
Получить практические навыки оркестрации контейнеризированных приложений в среде Kubernetes. Научиться транслировать архитектуру Docker Compose в манифесты K8s, управлять конфигурациями (ConfigMaps/Secrets), обеспечивать персистентность данных (PVC) и жизнеспособность сервисов (Probes).

## 2. Исходные данные и инструменты
Используются Docker-образы, созданные в **Лабораторной работе №2**.
Локальная среда оркестрации меняется с Docker Compose на **Minikube** (или Kind/K3s).

**Архитектура решения (Миграция из Docker Compose в K8s):**
-  **Database (Stateful):**
    *   *Compose:* Service `db` с named volume.
    *   *K8s:* Deployment (или StatefulSet) + **PersistentVolumeClaim (PVC)** + Service (ClusterIP).
-  **Analytics App (Stateless):**
    *   *Compose:* Service `app` с пробросом портов.
    *   *K8s:* Deployment (ReplicaSet) + **Service (NodePort)** + **Liveness/Readiness Probes**.
-  **Loader/Init (Ephemeral):**
    *   *Compose:* Service `loader`, запускающийся перед app.
    *   *K8s:* Объект **Job** (для разовой загрузки) или **InitContainer** внутри пода приложения (для проверки готовности БД).
-  **Configuration:**
    *   *Compose:* `.env` файл.
    *   *K8s:* Объекты **ConfigMap** (некритичные данные) и **Secret** (пароли, ключи).

## Ход работы

### Этап 1. Подготовка кластера и образов
-  Запустить Minikube: `minikube start`.
-  Перенести локальные Docker-образы из ЛР2 в среду Minikube (команда `minikube image load <image_name>` или использование локального registry), чтобы K8s мог их "видеть" без `imagePullPolicy: Always`.

### Этап 2. Управление конфигурацией и данными
-  **Secret.** Создать манифест `secret.yaml`. Перенести туда пароли от БД и API-ключи, закодированные в base64.
-  **ConfigMap.** Создать манифест `configmap.yaml`. Перенести туда несекретные переменные (хост БД, порты, настройки логирования).
-  **PVC.** Создать манифест `pvc.yaml` для базы данных (Request storage: 1Gi, AccessMode: ReadWriteOnce), чтобы данные не терялись при перезапуске пода БД.

### Этап 3. Описание Deployment и Service
-  **БД.** Написать `db-deployment.yaml`. Подключить PVC через `volumeMounts`. Подключить переменные из Secret. Создать `db-service.yaml` типа `ClusterIP` (внутренний доступ).
-  **Приложение.** Написать `app-deployment.yaml`.
    *   Настроить **InitContainer** (на базе `busybox`), который проверяет доступность сервиса БД (через `nc` или `nslookup`) перед стартом основного контейнера.
    *   Настроить **Liveness Probe** (проверка `/health`) и **Readiness Probe**.
    *   Создать `app-service.yaml` типа `NodePort` (или `LoadBalancer`), чтобы получить доступ к приложению из браузера хост-машины.

### Этап 4. Загрузка данных (Job)
Описать K8s **Job** (`loader-job.yaml`), который использует образ `loader` из ЛР2. Job должен запуститься, загрузить данные в БД и завершиться со статусом `Completed`.

---

## Варианты заданий (Кейсы)

Продолжаем работу с предметной областью из ЛР1 и ЛР2.

**Техническое задание (K8s Specific)** — особенность манифеста, которую необходимо реализовать.

Задания на образовательном портале [IT-Adaptive](https://envlab.ru/mod/assign/view.php?id=17)

---

## Критерии оценки 

Для получения оценки необходимо продемонстрировать работоспособность приложения в кластере Minikube и предоставить отчет.

| Критерий | Баллы | Детализация требований |
|:---|:---:|:---|
| **1. Манифесты Kubernetes (База)** | **6** | Корректно описаны Deployment для приложения и Deployment/StatefulSet для БД. Созданы Service (ClusterIP для БД, NodePort/LoadBalancer для App). Синтаксис YAML валиден. |
| **2. Конфигурация и Безопасность (Config/Secret)** | **4** | Отсутствие хардкода. Все переменные окружения (`ENV`) в подах берутся из `configMapRef` и `secretRef`. Секреты закодированы корректно. |
| **3. Хранение данных (Storage)** | **3** | Для базы данных настроен `PersistentVolumeClaim`. Продемонстрировано (в отчете), что при удалении пода БД (`kubectl delete pod`) и создании нового данные сохраняются. |
| **4. Жизненный цикл и Probes** | **3** | Настроены `LivenessProbe` и `ReadinessProbe`. Приложение не падает при старте, если БД еще не готова (использован InitContainer или логика retry). |
| **5. Специфика варианта** | **3** | Реализована и продемонстрирована специфическая техническая задача варианта (например, Job, CronJob, Sidecar, HPA и т.д.). |
| **6. Качество отчета** | **1** | Отчет содержит: описание архитектуры, листинги манифестов, скриншоты команд `kubectl get all`, `kubectl describe`, доказательство доступа к приложению через браузер/curl. |

**Итого:**
*   **0-9 баллов.** Неудовлетворительно (кластер не поднялся, манифесты с ошибками).
*   **10-14 баллов.** Удовлетворительно (приложение работает, но есть хардкод или не работает персистентность).

*   **15-20 баллов.** Хорошо/Отлично (полностью рабочая инфраструктура, выполнены все best practices).
